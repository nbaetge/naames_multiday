---
title: "Mix_Exp"
author: "Nicholas Baetge"
date: "2/24/2021"
output: github_document
---

# Intro

This document analyzes the Mixing remineralization experiment conducted on N3S1.

```{r Packages, message = F, warning = F}
library(tidyverse) 
library(ggpubr)
library(patchwork)
```

# Import and Tidy Data

```{r}
doc <- readRDS("~/GITHUB/naames_multiday/Input/processed_doc.rds") %>% 
  filter(Cruise == "AT38", Station == 1, Bottle %in% c("A", "B", "C", "D", "E", "F", "G", "H")) %>% 
  select(Depth:Treatment, Hours, contains("ptoc") )

bc <- readRDS("~/GITHUB/naames_multiday/Input/processed_bacterial_carbon.rds")  %>% 
  filter(Cruise == "AT38", Station == 1, Bottle %in% c("A", "B", "C", "D", "E", "F", "G", "H")) %>% 
  select(Bottle, Treatment, s.timepoint, contains("gf75.ret"), contains("i.poc.c1"), contains("s.poc.c1") )

ba <- readRDS("~/GITHUB/naames_multiday/Input/tidy_N2-4_BactA_Remin_Master.rds") %>% 
  filter(Cruise == "AT38", Station == 1, Bottle %in% c("A", "B", "C", "D", "E", "F", "G", "H"), !Treatment == "GF75") %>% 
  select(Depth:sd_cells) %>% 
  mutate(cells = ifelse(Hours >= 912, NA, cells),
         sd_cells = ifelse(Hours >= 912, NA, sd_cells))

merge <- full_join(ba, doc) %>% 
  left_join(., bc) %>% 
  arrange(Bottle, Timepoint) %>% 
  mutate(Days = round(Hours/24, 2)) %>% 
  select(Depth:Treatment, Hours, Days, everything()) %>% 
  group_by(Bottle) %>% 
  mutate(s.timepoint = ifelse(s.timepoint == Timepoint, Hours, NA)) %>% 
  fill(s.timepoint, .direction = "downup") %>%
  ungroup() %>% 
  rename(stationary.harvest = s.timepoint) %>% 
  select(Depth:Treatment, stationary.harvest, everything()) %>% 
  select(-c(contains(".ug"), Timepoint, contains("ptoc_from_"))) %>% 
  rename(i.poc = i.poc.c1.um,
         s.poc = s.poc.c1.um)
```

# Calculate Derived Variables

We need to readjust our initial bacterial carbon numbers before calculating other parameters. Since the initial condition was 1.2-µm filtrate, the carbon content of that filtrate would be higher than the 30:70 incubation mix at the beginning of the experiment. As a result we'll correct the initial carbon number to account for this: Bacterial POC~initial~ = 0.3 * Bacterial POC~1.2 µm filtrate~

We'll then calculate and define:

- doc.star = TOC or PTOC - POC (for N3 and 4)
- Bacterial growth efficiencies (BGE), only where ∆DOC is resolvable (>= 2.0 µmol C L^-1^ change):
  + ∆POC and ∆DOC (N2) or ∆DOC_star (N3) from T0 to stationary
  
```{r Calculate derived vars, message = F}
calcs <- merge  %>%
  mutate_at(vars(i.poc), funs(.*0.3)) %>% 
  group_by(Bottle) %>% 
######delta cells and poc ####
  mutate(del.cells = ifelse(Hours == stationary.harvest, cells - first(cells), NA),
         del.poc = round(s.poc - i.poc, 1)) %>% 
  fill(c(del.cells), .direction = "downup") %>% 
#######toc and doc star###
  mutate(doc.star_i = ifelse(Hours == 0, round(ptoc - i.poc, 1), NA),
         doc.star_s = ifelse(Hours == stationary.harvest, round(ptoc - s.poc, 1), NA)) %>% 
  fill(contains("star"), .direction = "downup") %>% 
######delta toc, toc.star, doc, doc.star####
  mutate(del.toc = ifelse(Hours == stationary.harvest, first(ptoc) - ptoc, NA),
         del.toc = ifelse(del.toc < 1.75, NA, del.toc),
      
         del.doc.star = doc.star_i - doc.star_s,
         del.doc.star = ifelse(del.doc.star < 1.75, NA, del.doc.star),
         del.doc.star = ifelse(del.toc < 1.75, NA, del.doc.star),
         ) %>% 
  fill(contains(c("del.toc", "del.doc")), .direction = "downup")  %>% 
  ######BGE####  
mutate(bge = del.poc/del.doc.star) %>% 
  mutate_at(vars(contains("bge")), round, 2) %>% 
   mutate(doc_star = ifelse(Hours < stationary.harvest, round(ptoc - i.poc,1), round(ptoc - s.poc,1)),
         doc_star = ifelse(Hours > stationary.harvest, ptoc, doc_star))  %>%  
  mutate(end.remin = last(Days),
         stationary.harvest = stationary.harvest/24,
         i.doc = first(doc_star),
         longterm.del.doc =  first(doc_star) - last(na.omit(ptoc)),
         longterm.del.doc = ifelse(longterm.del.doc < 2, NA, longterm.del.doc))  %>% 
  ungroup() %>% 
  select(Depth:stationary.harvest, end.remin, Hours:sd_ptoc, doc_star, i.doc, everything()) %>% 
  mutate(desc = ifelse(Depth == 10 & Treatment == "Control", "Surface-Surface", "Deep-Deep"),
         desc = ifelse(Treatment == "MixSD", "Surface-Deep", desc),
         desc = ifelse(Treatment == "MixDS", "Deep-Surface", desc)) %>% 
  select(Depth:Treatment, desc, everything()) %>% 
group_by(desc, Hours) %>% 
  mutate(trt_cells = round(mean(cells, na.rm = T)),
         sd_trt_cells = round(sd(cells, na.rm = T)),
         trt_toc = ifelse(!is.na(sd_ptoc), round(mean(ptoc, na.rm = T), 1), NA),
         sd_trt_toc = ifelse(!is.na(sd_ptoc), round(sd(ptoc, na.rm = T), 1), NA)) %>% 
  ungroup() %>% 
  group_by(desc) %>% 
  mutate(norm_toc =  round(trt_toc - first(trt_toc), 1),
         sd_norm_toc = ifelse(Hours != 0,  sd_trt_toc, NA),
         norm_cells = trt_cells - first(trt_cells),
         sd_norm_cells = ifelse(Hours != 0, sd_trt_cells, NA)) %>%
  ungroup() 
  

```

# Curves

## Cells

```{r incubation delta cells, message=FALSE, warning=FALSE}
ba_curves <- calcs %>% 
  drop_na(norm_cells) %>% 
  select(desc, Days, norm_cells, sd_norm_cells) %>% 
  distinct() %>% 
  ggplot(aes(x = Days, y = norm_cells, group = interaction(desc))) +
  geom_errorbar(aes(ymin = norm_cells - sd_norm_cells, ymax = norm_cells + sd_norm_cells, color = factor(desc)), width = 0.3, alpha = 0.5) +
  geom_line(aes(color = factor(desc)), alpha = 0.7) +
  geom_point(aes(fill = factor(desc)), size = 3, shape = 21, alpha = 0.7) +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
 labs(x = expression("Days"), y = expression(paste("Bacterial Abundance, Cells L"^-1)), fill = "") +
  theme_classic2(base_size = 16) +
  guides(color = F, linetype = F)  +
  guides(fill = guide_legend(reverse = T))
```
## DOC

```{r incubation delta doc, message=FALSE, warning=FALSE}
doc_curves <-  calcs %>% 
  drop_na(sd_trt_toc) %>% 
 select(desc, Days, norm_toc, sd_norm_toc) %>% 
  distinct() %>% 
  ggplot(aes(x = Days, y = norm_toc, group = interaction(desc))) +
  geom_errorbar(aes(ymin = norm_toc - sd_norm_toc, ymax = norm_toc + sd_norm_toc, color = factor(desc)), width = 1, alpha = 0.5) +
  geom_line(aes(color = factor(desc)), alpha = 0.7) +
  geom_point(aes(fill = factor(desc)), size = 3, shape = 21, alpha = 0.7) +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
  labs(x = expression("Days"), y = expression(paste("TOC, µmol C L"^-1)), fill = "") +
  theme_classic2(base_size = 16) +
  theme(strip.background.x = element_blank(),
        strip.text.x = element_blank()) +
  guides(color = F, fill = F) 
```

```{r fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
ba_curves + doc_curves + 
   plot_annotation(tag_levels = "a") +
  plot_layout(guides = "collect") +
  theme(plot.tag = element_text(size = 14)) 
```


## Cells

```{r incubation delta cells, message=FALSE, warning=FALSE}
ba_curves2 <- calcs %>% 
  drop_na(trt_cells) %>% 
  select(desc, Days, trt_cells, sd_trt_cells) %>% 
  distinct() %>% 
  ggplot(aes(x = Days, y = trt_cells, group = interaction(desc))) +
  geom_errorbar(aes(ymin = trt_cells - sd_trt_cells, ymax = trt_cells + sd_trt_cells, color = factor(desc)), width = 0.3, alpha = 0.5) +
  geom_line(aes(color = factor(desc)), alpha = 0.7) +
  geom_point(aes(fill = factor(desc)), size = 3, shape = 21, alpha = 0.7) +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
 labs(x = expression("Days"), y = expression(paste("Bacterial Abundance, Cells L"^-1)), fill = "") +
  theme_classic2(base_size = 16) +
  guides(color = F, linetype = F)  +
  guides(fill = guide_legend(reverse = T))
```
## DOC

```{r incubation delta doc, message=FALSE, warning=FALSE}
doc_curves2 <-  calcs %>% 
  drop_na(sd_trt_toc) %>% 
 select(desc, Days, trt_toc, sd_trt_toc) %>% 
  distinct() %>% 
  ggplot(aes(x = Days, y = trt_toc, group = interaction(desc))) +
  geom_errorbar(aes(ymin = trt_toc - sd_trt_toc, ymax = trt_toc + sd_trt_toc, color = factor(desc)), width = 1, alpha = 0.5) +
  geom_line(aes(color = factor(desc)), alpha = 0.7) +
  geom_point(aes(fill = factor(desc)), size = 3, shape = 21, alpha = 0.7) +
  scale_color_viridis_d(option = "viridis") +
  scale_fill_viridis_d(option = "viridis") +
  labs(x = expression("Days"), y = expression(paste("TOC, µmol C L"^-1)), fill = "") +
  theme_classic2(base_size = 16) +
  theme(strip.background.x = element_blank(),
        strip.text.x = element_blank()) +
  guides(color = F, fill = F) 
```

```{r fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
ba_curves2 + doc_curves2 + 
   plot_annotation(tag_levels = "a") +
  plot_layout(guides = "collect") +
  theme(plot.tag = element_text(size = 14)) 
```

















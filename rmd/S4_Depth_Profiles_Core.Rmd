---
title: "S4_Depth_Profiles_CORE"
author: "Nicholas Baetge"
date: "2/25/2021"
output: github_document
---

# Intro

Here, we plot the profiles from the multiday NAAMES station, N2S4.

```{r load libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(hms)
library(zoo) 
library(oce)  
library(ggpubr)
library(patchwork)
```


# Import Data

These casts have been excluded from further analysis (see Float and Ship T-S analysis): 
!plot_date %in% c("May 24 02:30", "May 27 06:07")

```{r}
all <- read_rds("~/GITHUB/naames_multiday/Input/bottle_data.rds") %>% 
  filter(Cruise == "AT34", z >= 0, z <= 200) 
 
bf <- read_rds("~/GITHUB/naames_multiday/Input/bottle_data.rds") %>% 
  filter(Cruise == "AT34", Station == 4, !plot_date %in% c("May 24 02:30", "May 27 06:07"), z > 0, z <= 200) 
  
ctd <- read_rds("~/GITHUB/naames_multiday/Input/ctd_data.rds") %>% 
   filter(Cruise == "AT34", Station == 4, !plot_date %in% c("May 24 02:30", "May 27 06:07"), z > 0, z <= 200) 

npp <- read_rds("~/GITHUB/naames_multiday/Input/npp_data.rds") %>% 
   filter(Cruise == "AT34", Station == 4, !plot_date %in% c("May 24 02:30", "May 27 06:07"), z > 0, z <= 200) 

phyto <- read_rds("~/GITHUB/naames_multiday/Input/phyto_data.rds") %>% 
   filter(Cruise == "AT34", station == "S4", !plot_date %in% c("May 24 02:30", "May 27 06:07"), depth > 0, depth <= 200) 

int_bf <- read_rds("~/GITHUB/naames_multiday/Output/integrated_bf.rds") %>% 
  filter(Cruise == "AT34", Station == 4, !plot_date %in% c("May 24 02:30", "May 27 06:07")) 

```

## Plot Profiles 

### Chl

```{r chl plot, echo = FALSE, warning = FALSE, message = FALSE}

chl.plot <-  bf %>% 
  drop_na(chl) %>% 
  # µg / L = mg / m3
  ggplot(aes(x = z, y = chl, color = plot_date, fill = plot_date, group = interaction(datetime, CampCN))) +
  geom_vline(xintercept = 77, color = "red") +
  geom_line(size = 0.7) +
  geom_point(shape = 21, size = 6, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = "Depth (m)", y = expression(paste("Chl ", italic("a"), " (ug L"^"-1", ")")), colour = "", fill = "Date") +
  expand_limits(x = 200) +
  scale_x_reverse() +
  coord_flip() +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  guides(color = F) +
  theme_linedraw(base_size = 20) +
  theme(panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.title = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.position = c(0.8, 0.2),
        legend.text = element_text(size = 12),
        legend.background = element_rect(size = 0.2, linetype = "solid", color = "black"),
        legend.spacing.y = unit(0, "pt"))

```

```{r}
bf %>% 
  mutate(dh = ifelse(z <= 75, "ez", "mz")) %>% 
  drop_na(chl) %>% 
  filter( CampCN %in% c(53, 67)) %>% 
  group_by(dh) %>% do(broom::tidy(t.test(chl ~ CampCN, data = .)))
  
```



### Phyto Cells

```{r phyto plot, echo = FALSE, warning = FALSE, message = FALSE}
phyto.plot <-  phyto %>% 
  # mutate(phyto = phyto * 10^3) %>% 
  select(plot_date, depth, phyto) %>% 
  ggplot(aes(x = depth, y = phyto, color = plot_date, fill = plot_date, group = interaction(plot_date))) +
  # geom_errorbar(aes(x = z, ymin = ave_phyto - sd_phyto, ymax = ave_phyto + sd_phyto)) +
  geom_vline(xintercept = 77, color = "red") +
  geom_line(size = 0.7) +
  geom_point(shape = 21, size = 6, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = "", y = expression(paste("Phytoplankton (cells L"^-1, ")")), color = "", fill = "Date") +
  expand_limits(x = 200) +
  scale_x_reverse() +
  coord_flip() +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  guides(colour = F, shape = F, linetype = F) +
  theme_linedraw(base_size = 20) +
  theme(panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.title = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.position = c(0.8, 0.3),
        legend.text = element_text(size = 12),
        legend.background = element_rect(size = 0.2, linetype = "solid", color = "black"),
        legend.spacing.y = unit(0, "pt"))
```

```{r}
phyto %>% 
  mutate(dh = ifelse(depth <= 75, "ez", "mz")) %>% 
  drop_na(phyto) %>% 
  filter( plot_date %in% c("May 24 06:10", "May 27 14:56")) %>% 
  group_by(dh) %>% do(broom::tidy(t.test(phyto ~ plot_date, data = .)))
  
```

### NPP

```{r npp plot, echo = FALSE, warning = FALSE, message = FALSE}
npp.plot <-  npp %>% 
  # mutate(npp = npp/10^3) %>% 
  ggplot(aes(x = z, y = npp, color = plot_date, fill = plot_date, group = plot_date)) +
  geom_vline(xintercept = 77, color = "red") +
  geom_line(size = 2) +
  labs(x = "", y = expression(paste("Modeled NPP (µmol C L"^-1, " d"^-1, ")")), colour = "Date") +
  expand_limits(x = 200) +
  scale_x_reverse() +
  coord_flip() +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  guides(fill = F, shape = F, linetype = F) +
  theme_linedraw(base_size = 20) +
  theme(panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.title = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.position = c(0.85, 0.15),
        legend.text = element_text(size = 12),
        legend.background = element_rect(size = 0.2, linetype = "solid", color = "black"),
        legend.spacing.y = unit(0, "pt"))

```

```{r}
npp %>% 
  mutate(dh = ifelse(z <= 75, "ez", "mz")) %>% 
  drop_na(npp) %>% 
  filter( plot_date %in% c("May 24", "May 27")) %>% 
  group_by(dh) %>% do(broom::tidy(t.test(npp ~ plot_date, data = .)))
  
```

### N

```{r n plot, echo = FALSE, warning = FALSE, message = FALSE}
n.plot <-  bf %>% 
  drop_na(n) %>% 
  ggplot(aes(x = z, y = n, color = plot_date, fill = plot_date, group = interaction(plot_date, CampCN))) +
  geom_errorbar(aes(x = z, ymin = n - sd_n, ymax = n + sd_n)) +
  geom_vline(xintercept = 77, color = "red") +
  geom_line(size = 0.7) +
  geom_point(shape = 21, size = 6,  color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = "Depth (m)", y = expression(paste("N + N (µmol N L"^-1, ")")), colour = "", fill = "Date") +
  scale_x_reverse() +
  coord_flip() +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  guides(colour = F, shape = F, linetype = F) +
  theme_linedraw(base_size = 20) +
  theme(panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.title = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.position = c(0.25, 0.15),
        legend.text = element_text(size = 12),
        legend.background = element_rect(size = 0.2, linetype = "solid", color = "black"),
        legend.spacing.y = unit(0, "pt"))

```

```{r}
bf %>% 
  mutate(dh = ifelse(z <= 75, "ez", "mz")) %>% 
  drop_na(n) %>% 
  filter( CampCN %in% c(52, 61)) %>% 
  group_by(dh) %>% do(broom::tidy(t.test(n ~ CampCN, data = .)))
  
```

### DOC

```{r doc plot, echo = FALSE, warning = FALSE, message = FALSE}
doc.plot <- bf %>% 
  drop_na(doc) %>% 
  ggplot(aes(x = z, y = doc, color = plot_date, fill = plot_date, group = interaction(plot_date, CampCN))) +
  geom_errorbar(aes(x = z, ymin = doc - sd_doc, ymax = doc + sd_doc)) +
  geom_vline(xintercept = 77, color = "red") +
  geom_line(size = 0.7) +
  geom_point(shape = 21, size = 6, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = "", y = expression(paste("DOC (µmol C L"^-1, ")")), colour = "", fill = "Date") +
  scale_x_reverse() +
  coord_flip() +
  scale_y_continuous(limits = c(50.2, 55)) +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  guides( color = F, linetype = F, shape = F) +
  theme_linedraw(base_size = 20) +
  theme(panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.title = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.position = c(0.15, 0.2),
        legend.text = element_text(size = 12),
        legend.background = element_rect(size = 0.2, linetype = "solid", color = "black"),
        legend.spacing.y = unit(0, "pt"))

```

```{r}
bf %>% 
  mutate(dh = ifelse(z <= 75, "ez", "mz")) %>% 
  drop_na(doc) %>% 
  filter( CampCN %in% c(52, 61)) %>% 
  group_by(dh) %>% do(broom::tidy(t.test(doc ~ CampCN, data = .)))
  
```

### TDAA

```{r tdaa plot, echo = FALSE, warning = FALSE, message = FALSE}
tdaa.plot <- bf %>% 
  drop_na(tdaa_c) %>%
  ggplot(aes(x = z, y = tdaa_c, color = plot_date, fill = plot_date, group = interaction(plot_date, CampCN))) +
  geom_errorbar(aes(x = z, ymin = tdaa_c - sd_tdaa, ymax = tdaa_c + sd_tdaa)) +
  geom_vline(xintercept = 77, color = "red") +
  geom_line(size = 0.7) +
  geom_point(shape = 21, size = 6, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = "", y = expression(paste("TDAA (µmol C L"^-1, ")")), colour = "", fill = "Date") +
  scale_x_reverse() +
  coord_flip() +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  guides(color = F, linetype = F, shape = F) +
  theme_linedraw(base_size = 20) +
  theme(legend.title = element_blank(),
        panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.key.size = unit(1, "cm")) +
  theme(panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.title = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.position = c(0.8, 0.15),
        legend.text = element_text(size = 12),
        legend.background = element_rect(size = 0.2, linetype = "solid", color = "black"),
        legend.spacing.y = unit(0, "pt"))

```

```{r}
bf %>% 
  mutate(dh = ifelse(z <= 75, "ez", "mz")) %>% 
  drop_na(tdaa) %>% 
  filter( CampCN %in% c(52, 61)) %>% 
  group_by(dh) %>% do(broom::tidy(t.test(tdaa ~ CampCN, data = .)))
  
```

### AOU

```{r aou plot, echo = FALSE, warning = FALSE, message = FALSE}
aou.plot <-  ctd %>% 
  drop_na(aou) %>% 
  ggplot(aes(x = z, y = aou, color = plot_date, fill = plot_date, group = plot_date)) +
  # geom_ribbon(aes(ymin = aou - sd_aou, ymax = aou + sd_aou), alpha = 0.5) +
  geom_vline(xintercept = 77, color = "red") +
  geom_line(size = 0.7) +
  labs(x = "", y = expression(paste("AOU (µmol O"[2]," L"^-1, ")")), colour = "Date", fill = "") +
  scale_x_reverse() +
  coord_flip() +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  guides(fill = F, shape = F, linetype = F) +
  theme_linedraw(base_size = 20) +
  theme(panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.title = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.position = c(0.2, 0.4),
        legend.text = element_text(size = 12),
        legend.background = element_rect(size = 0.2, linetype = "solid", color = "black"),
        legend.spacing.y = unit(0, "pt"))

```

```{r}
ctd %>% 
  mutate(dh = ifelse(z <= 75, "ez", "mz")) %>% 
  drop_na(aou) %>% 
  filter( plot_date %in% c("May 24 04:11", "May 27 20:16")) %>% 
  group_by(dh) %>% do(broom::tidy(t.test(aou ~ plot_date, data = .)))
  
```

### BactA

```{r bactC plot, echo = FALSE, warning = FALSE, message = FALSE}
ba.plot <-  bf %>% 
  drop_na(ba) %>% 
  ggplot(aes(x = z, y = ba, color = plot_date, fill = plot_date, group = interaction(plot_date, CampCN))) +
  geom_errorbar(aes(x = z, ymin = ba - sd_ba, ymax = ba + sd_ba)) +
  geom_vline(xintercept = 77, color = "red") +
  geom_line(size = 0.7) +
  geom_point(shape = 21, size = 6, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = "Depth, m", y = expression(paste("BA (cells L"^-1, ")")), colour = "", linetype = "Eddy Location", shape = "Eddy Location", fill = "Date") +
  scale_x_reverse() +
  coord_flip() +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  guides(colour = F, shape = F, linetype = F) +
  theme_linedraw(base_size = 20) +
  theme(panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.title = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.position = c(0.8, 0.15),
        legend.text = element_text(size = 12),
        legend.background = element_rect(size = 0.2, linetype = "solid", color = "black"),
        legend.spacing.y = unit(0, "pt"))

```

```{r}
bf %>% 
  mutate(dh = ifelse(z <= 75, "ez", "mz")) %>% 
  drop_na(ba) %>% 
  filter( CampCN %in% c(52, 61)) %>% 
  group_by(dh) %>% do(broom::tidy(t.test(ba ~ CampCN, data = .)))
  
```

### Leu

```{r bp plot, echo = FALSE, warning = FALSE, message = FALSE}
leu.plot <-  bf %>% 
  drop_na(bp) %>% 
  ggplot(aes(x = z, y = bp, color = plot_date, fill = plot_date, group = interaction(plot_date, CampCN))) +
  geom_errorbar(aes(x = z, ymin = bp - sd_bp, ymax = bp + sd_bp), width = 5) +
  geom_vline(xintercept = 77, color = "red") +
  geom_line(size = 0.7) +
  geom_point(shape = 21, size = 6, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = "", y = expression(paste("BP (nmol C L"^-1,"d"^-1, ")")), colour = "", fill = "Date") +
  scale_x_reverse() +
  coord_flip() +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  guides(color = F, linetype = F, shape = F) +
  theme_linedraw(base_size = 20) +
  theme(panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.title = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.position = c(0.8, 0.25),
        legend.text = element_text(size = 12),
        legend.background = element_rect(size = 0.2, linetype = "solid", color = "black"),
        legend.spacing.y = unit(0, "pt"))

```

```{r}
bf %>% 
  mutate(dh = ifelse(z <= 75, "ez", "mz")) %>% 
  drop_na(bp) %>% 
  filter( CampCN %in% c(52, 61)) %>% 
  group_by(dh) %>% do(broom::tidy(t.test(bp ~ CampCN, data = .)))
  
```

```{r bp plot2, echo=FALSE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}
all %>% 
  drop_na(bp) %>% 
  ggplot(aes(x = z, y = bp, color = as_factor(Station), fill = as_factor(Station), group = interaction(plot_date, CampCN))) +
  geom_errorbar(aes(x = z, ymin = bp - sd_bp, ymax = bp + sd_bp), width = 5) +
  geom_line(size = 0.7) +
  geom_point(shape = 21, size = 6, color = "black", stroke = 1, alpha = 0.7) + 
  labs(x = "", y = expression(paste("BP (nmol C L"^-1, "d"^-1, ")")), fill = "Station", color = "Station") +
  scale_x_reverse() +
  coord_flip() +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  guides(color = F, linetype = F, shape = F) +
  theme_linedraw(base_size = 20) +
  theme(panel.spacing.x = unit(1, "cm"),
        axis.text.x = element_text(angle = 0),
        legend.title = element_text(size = 14),
        legend.key.size = unit(0.4, "cm"),
        legend.position = c(0.8, 0.25),
        legend.text = element_text(size = 12),
        legend.background = element_rect(size = 0.2, linetype = "solid", color = "black"),
        legend.spacing.y = unit(0, "pt"))

```



## Combine Plots

```{r combine plots, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 20, fig.width = 23}

patchwork <-  n.plot + (chl.plot ) + (phyto.plot ) +  (leu.plot )  + (aou.plot) + (doc.plot) + (npp.plot  ) + (ba.plot + theme(legend.background = element_rect(size = 0.2, linetype = "solid", color = "black", fill = "transparent"), legend.box.background = element_rect(fill = 'transparent')))  + (tdaa.plot)

patchwork +  
  # plot_layout(guides = 'collect') +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 22)) 

```


```{r combine plots2, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 12, fig.width = 20}

patchwork <-  n.plot + (chl.plot ) + (phyto.plot ) +  (leu.plot )  +   (ba.plot + theme(legend.background = element_rect(size = 0.2, linetype = "solid", color = "black", fill = "transparent"), legend.box.background = element_rect(fill = 'transparent'))) + (doc.plot) 

patchwork +  
  # plot_layout(guides = 'collect') +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 22)) 

```

